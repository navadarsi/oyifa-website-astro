---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import { useTranslations } from '../../../i18n/utils';
import { getAllPosts, getPostBySlug, getLocalizedText, getLocalizedBlock, type Post } from '../../../lib/sanity';

export async function getStaticPaths() {
  const posts = await getAllPosts();
  return posts.map((post) => ({
    params: { slug: post.slug.current },
  }));
}

const { slug } = Astro.params;
const t = useTranslations('ar');
const lang = 'ar';

const post = await getPostBySlug(slug as string);

if (!post) {
  return Astro.redirect('/ar/blog');
}

function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('ar-SA', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

const title = getLocalizedText(post.title, lang);
const excerpt = getLocalizedText(post.excerpt, lang);
const metaTitle = post.seo?.metaTitle ? getLocalizedText(post.seo.metaTitle, lang) : title;
const metaDescription = post.seo?.metaDescription ? getLocalizedText(post.seo.metaDescription, lang) : excerpt;
const body = getLocalizedBlock(post.body, lang);

// BlogPosting Schema for SEO
const blogSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": title,
  "description": excerpt,
  "image": post.mainImage?.asset?.url,
  "datePublished": post.publishedAt,
  "inLanguage": "ar",
  "author": {
    "@type": "Person",
    "name": post.author ? getLocalizedText(post.author.name, lang) : "فريق أويفا"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Oyifa",
    "logo": {
      "@type": "ImageObject",
      "url": "https://oyifa.com/logo.png"
    }
  }
};

// Breadcrumb Schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "الرئيسية",
      "item": "https://oyifa.com/ar"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "المدونة",
      "item": "https://oyifa.com/ar/blog"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": title,
      "item": `https://oyifa.com/ar/blog/${slug}`
    }
  ]
};
---

<BaseLayout title={metaTitle} description={metaDescription}>
  <Header />

  <!-- Schema Markup -->
  <script type="application/ld+json" set:html={JSON.stringify(blogSchema)}></script>
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)}></script>

  <main class="pt-24">
    <article>
      <!-- Hero -->
      <header class="py-12 px-4 bg-gradient-to-b from-purple-50 to-white">
        <div class="max-w-4xl mx-auto">
          <!-- Breadcrumb -->
          <nav class="mb-6 text-sm" aria-label="Breadcrumb">
            <ol class="flex items-center gap-2 text-gray-500">
              <li><a href="/ar" class="hover:text-primary">الرئيسية</a></li>
              <li>/</li>
              <li><a href="/ar/blog" class="hover:text-primary">المدونة</a></li>
              <li>/</li>
              <li class="text-gray-900 truncate max-w-[200px]">{title}</li>
            </ol>
          </nav>

          {post.categories && post.categories.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-4">
              {post.categories.map((category) => (
                <span
                  class="text-sm font-medium px-3 py-1 rounded-full"
                  style={category.color ? `background-color: ${category.color}20; color: ${category.color}` : 'background-color: #8B5CF620; color: #8B5CF6'}
                >
                  {getLocalizedText(category.title, lang)}
                </span>
              ))}
            </div>
          )}

          <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 mb-6">
            {title}
          </h1>

          {excerpt && (
            <p class="text-xl text-gray-600 mb-6">{excerpt}</p>
          )}

          <div class="flex items-center gap-4 text-gray-600">
            {post.author && (
              <div class="flex items-center gap-3">
                {post.author.image?.asset?.url && (
                  <img
                    src={post.author.image.asset.url}
                    alt={getLocalizedText(post.author.name, lang)}
                    class="w-10 h-10 rounded-full object-cover"
                  />
                )}
                <span class="font-medium">{getLocalizedText(post.author.name, lang)}</span>
              </div>
            )}
            <span class="text-gray-400">•</span>
            <time datetime={post.publishedAt}>{formatDate(post.publishedAt)}</time>
          </div>
        </div>
      </header>

      <!-- Featured Image -->
      {post.mainImage?.asset?.url && (
        <div class="max-w-5xl mx-auto px-4 -mt-4 mb-12">
          <img
            src={post.mainImage.asset.url}
            alt={getLocalizedText(post.mainImage.alt, lang) || title}
            class="w-full rounded-2xl shadow-lg"
          />
        </div>
      )}

      <!-- Content -->
      <div class="py-12 px-4">
        <div class="max-w-3xl mx-auto prose prose-lg">
          {body.map((block: any) => {
            if (block._type === 'block') {
              const style = block.style || 'normal';
              const text = block.children?.map((child: any) => child.text).join('') || '';

              if (style === 'h2') return <h2>{text}</h2>;
              if (style === 'h3') return <h3>{text}</h3>;
              if (style === 'h4') return <h4>{text}</h4>;
              if (style === 'blockquote') return <blockquote>{text}</blockquote>;
              return <p>{text}</p>;
            }
            if (block._type === 'image' && block.asset?.url) {
              return (
                <figure class="my-8">
                  <img src={block.asset.url} alt={block.alt || ''} class="rounded-lg" />
                  {block.caption && <figcaption class="text-center text-sm text-gray-500 mt-2">{block.caption}</figcaption>}
                </figure>
              );
            }
            return null;
          })}
        </div>
      </div>

      <!-- Author Bio -->
      {post.author && (
        <div class="py-12 px-4 bg-gray-50">
          <div class="max-w-3xl mx-auto">
            <div class="bg-white rounded-2xl shadow-sm p-6 flex items-start gap-4">
              {post.author.image?.asset?.url && (
                <img
                  src={post.author.image.asset.url}
                  alt={getLocalizedText(post.author.name, lang)}
                  class="w-16 h-16 rounded-full object-cover"
                />
              )}
              <div>
                <h3 class="font-semibold text-gray-900">{getLocalizedText(post.author.name, lang)}</h3>
                {post.author.bio && (
                  <p class="text-gray-600 mt-2">
                    {getLocalizedBlock(post.author.bio, lang).map((block: any) =>
                      block.children?.map((child: any) => child.text).join('') || ''
                    ).join(' ')}
                  </p>
                )}
                {post.author.social && (
                  <div class="flex gap-3 mt-3">
                    {post.author.social.twitter && (
                      <a href={`https://twitter.com/${post.author.social.twitter}`} target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-primary">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                      </a>
                    )}
                    {post.author.social.linkedin && (
                      <a href={post.author.social.linkedin} target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-primary">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                      </a>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      <!-- Back to Blog -->
      <div class="py-8 px-4">
        <div class="max-w-3xl mx-auto">
          <a href="/ar/blog" class="inline-flex items-center gap-2 text-primary hover:underline">
            <svg class="w-5 h-5 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            <span>{t('blog.backToBlog')}</span>
          </a>
        </div>
      </div>
    </article>
  </main>

  <Footer />
</BaseLayout>

<style>
  .prose h2 {
    @apply text-2xl font-bold text-gray-900 mt-10 mb-4;
  }
  .prose h3 {
    @apply text-xl font-semibold text-gray-900 mt-8 mb-3;
  }
  .prose h4 {
    @apply text-lg font-semibold text-gray-900 mt-6 mb-3;
  }
  .prose p {
    @apply text-gray-600 mb-4 leading-relaxed;
  }
  .prose blockquote {
    @apply border-r-4 border-primary pr-4 italic text-gray-700 my-6;
  }
  .prose ul, .prose ol {
    @apply mb-4 space-y-2 text-gray-600;
  }
  .prose a {
    @apply text-primary hover:underline;
  }
</style>
