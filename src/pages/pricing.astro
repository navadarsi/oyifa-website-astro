---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { useTranslations } from '../i18n/utils';

const t = useTranslations('en');

// Regional pricing data (pre-rendered for SEO, JS switches display)
const pricing = {
  // UAE, Saudi, Qatar - Higher tier
  AED: { symbol: 'AED', monthly: { basic: 499, standard: 999, premium: 1499 }, yearly: { basic: 4999, standard: 9999, premium: 14999 } },
  SAR: { symbol: 'SAR', monthly: { basic: 499, standard: 999, premium: 1499 }, yearly: { basic: 4999, standard: 9999, premium: 14999 } },
  QAR: { symbol: 'QAR', monthly: { basic: 499, standard: 999, premium: 1499 }, yearly: { basic: 4999, standard: 9999, premium: 14999 } },
  // Bahrain, Kuwait, Oman - Lower tier
  BHD: { symbol: 'BHD', monthly: { basic: 49, standard: 99, premium: 149 }, yearly: { basic: 499, standard: 999, premium: 1499 } },
  KWD: { symbol: 'KWD', monthly: { basic: 49, standard: 99, premium: 149 }, yearly: { basic: 499, standard: 999, premium: 1499 } },
  OMR: { symbol: 'OMR', monthly: { basic: 49, standard: 99, premium: 149 }, yearly: { basic: 499, standard: 999, premium: 1499 } },
  // USD fallback
  USD: { symbol: '$', monthly: { basic: 129, standard: 259, premium: 399 }, yearly: { basic: 1299, standard: 2599, premium: 3999 } },
};

// Default to AED for GCC focus
const defaultCurrency = 'AED';
const p = pricing[defaultCurrency];

const plans = [
  {
    name: t('pricing.free'),
    monthlyPrice: 0,
    yearlyPrice: 0,
    proposals: '0',
    features: [
      t('pricing.features.proposals') + ': 0',
      t('pricing.features.support'),
    ],
    cta: t('pricing.getStarted'),
    popular: false,
  },
  {
    name: t('pricing.basic'),
    monthlyPrice: p.monthly.basic,
    yearlyPrice: p.yearly.basic,
    proposals: '10',
    features: [
      t('pricing.features.proposals') + ': 10',
      t('pricing.features.support'),
    ],
    cta: t('pricing.getStarted'),
    popular: false,
  },
  {
    name: t('pricing.standard'),
    monthlyPrice: p.monthly.standard,
    yearlyPrice: p.yearly.standard,
    proposals: '50',
    features: [
      t('pricing.features.proposals') + ': 50',
      t('pricing.features.priority'),
      t('pricing.features.analytics'),
    ],
    cta: t('pricing.getStarted'),
    popular: true,
  },
  {
    name: t('pricing.premium'),
    monthlyPrice: p.monthly.premium,
    yearlyPrice: p.yearly.premium,
    proposals: t('pricing.unlimited'),
    features: [
      t('pricing.features.proposals') + ': ' + t('pricing.unlimited'),
      t('pricing.features.priority'),
      t('pricing.features.analytics'),
      t('pricing.features.dedicated'),
    ],
    cta: t('pricing.getStarted'),
    popular: false,
  },
];
---

<BaseLayout title={t('nav.pricing')} description="Simple, transparent pricing for Oyifa. Choose the plan that fits your business needs.">
  <Header />

  <main class="pt-24">
    <!-- Hero -->
    <section class="py-16 px-4 bg-gradient-to-b from-purple-50 to-white">
      <div class="max-w-4xl mx-auto text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
          {t('pricing.title')}
        </h1>
        <p class="text-xl text-gray-600">
          {t('pricing.subtitle')}
        </p>

        <!-- Billing Toggle -->
        <div class="mt-8 flex flex-col items-center gap-4">
          <div class="inline-flex items-center bg-white rounded-full shadow-sm p-1">
            <button id="monthly-btn" class="px-6 py-2 rounded-full text-sm font-medium transition-colors bg-primary text-white">
              {t('pricing.monthly')}
            </button>
            <button id="yearly-btn" class="px-6 py-2 rounded-full text-sm font-medium transition-colors text-gray-600 hover:text-gray-900">
              {t('pricing.yearly')} <span class="text-green-600 text-xs ml-1">{t('pricing.save')}</span>
            </button>
          </div>

          <!-- Currency selector -->
          <div class="inline-flex items-center gap-2 bg-white rounded-lg shadow-sm p-1">
            <span class="text-sm text-gray-500 px-2">Currency:</span>
            <select id="currency-select" class="bg-transparent border-0 text-gray-700 font-medium focus:ring-0 cursor-pointer">
              <option value="AED">AED (UAE)</option>
              <option value="SAR">SAR (Saudi)</option>
              <option value="QAR">QAR (Qatar)</option>
              <option value="KWD">KWD (Kuwait)</option>
              <option value="BHD">BHD (Bahrain)</option>
              <option value="OMR">OMR (Oman)</option>
              <option value="USD">USD</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- Pricing Cards -->
    <section class="py-16 px-4">
      <div class="max-w-7xl mx-auto">
        <div class="grid md:grid-cols-4 gap-6">
          {plans.map((plan, index) => (
            <div class={`relative bg-white rounded-2xl shadow-lg p-6 ${plan.popular ? 'ring-2 ring-primary' : 'border border-gray-200'}`}>
              {plan.popular && (
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-primary text-white text-sm font-medium px-3 py-1 rounded-full">
                  {t('pricing.popular')}
                </div>
              )}
              <div class="text-center mb-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-2">{plan.name}</h3>
                <div class="flex items-baseline justify-center gap-1">
                  <span class="currency-symbol text-2xl font-bold text-gray-900">{p.symbol}</span>
                  <span class="price text-4xl font-bold text-gray-900"
                    data-monthly={JSON.stringify({
                      AED: index === 0 ? 0 : index === 1 ? 499 : index === 2 ? 999 : 1499,
                      SAR: index === 0 ? 0 : index === 1 ? 499 : index === 2 ? 999 : 1499,
                      QAR: index === 0 ? 0 : index === 1 ? 499 : index === 2 ? 999 : 1499,
                      KWD: index === 0 ? 0 : index === 1 ? 49 : index === 2 ? 99 : 149,
                      BHD: index === 0 ? 0 : index === 1 ? 49 : index === 2 ? 99 : 149,
                      OMR: index === 0 ? 0 : index === 1 ? 49 : index === 2 ? 99 : 149,
                      USD: index === 0 ? 0 : index === 1 ? 129 : index === 2 ? 259 : 399,
                    })}
                    data-yearly={JSON.stringify({
                      AED: index === 0 ? 0 : index === 1 ? 4999 : index === 2 ? 9999 : 14999,
                      SAR: index === 0 ? 0 : index === 1 ? 4999 : index === 2 ? 9999 : 14999,
                      QAR: index === 0 ? 0 : index === 1 ? 4999 : index === 2 ? 9999 : 14999,
                      KWD: index === 0 ? 0 : index === 1 ? 499 : index === 2 ? 999 : 1499,
                      BHD: index === 0 ? 0 : index === 1 ? 499 : index === 2 ? 999 : 1499,
                      OMR: index === 0 ? 0 : index === 1 ? 499 : index === 2 ? 999 : 1499,
                      USD: index === 0 ? 0 : index === 1 ? 1299 : index === 2 ? 2599 : 3999,
                    })}>{plan.monthlyPrice}</span>
                  <span class="billing-period text-gray-500">{t('pricing.perMonth')}</span>
                </div>
                <p class="text-sm text-gray-500 mt-2">{plan.proposals} {t('pricing.proposals')}</p>
              </div>
              <ul class="space-y-3 mb-6">
                {plan.features.map((feature) => (
                  <li class="flex items-center gap-2 text-gray-600">
                    <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    {feature}
                  </li>
                ))}
              </ul>
              <a
                href={`/app/register?plan=${plan.name.toLowerCase()}`}
                class={`block w-full text-center py-3 rounded-lg font-semibold transition-colors ${
                  plan.popular
                    ? 'bg-primary text-white hover:bg-primary-light'
                    : 'bg-gray-100 text-gray-900 hover:bg-gray-200'
                }`}
              >
                {plan.cta}
              </a>
            </div>
          ))}
        </div>
      </div>
    </section>

    <!-- FAQ Teaser -->
    <section class="py-16 px-4 bg-gray-50">
      <div class="max-w-3xl mx-auto text-center">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Have questions?</h2>
        <p class="text-gray-600 mb-6">Check out our FAQ or contact our support team.</p>
        <div class="flex gap-4 justify-center">
          <a href="/faq" class="bg-white border border-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-colors">
            View FAQ
          </a>
          <a href="/contact" class="bg-primary text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-light transition-colors">
            Contact Us
          </a>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</BaseLayout>

<script>
  const symbols: Record<string, string> = {
    AED: 'AED', SAR: 'SAR', USD: '$', KWD: 'KWD', QAR: 'QAR', BHD: 'BHD', OMR: 'OMR'
  };

  let currentBilling: 'monthly' | 'yearly' = 'monthly';
  let currentCurrency = 'AED';

  const select = document.getElementById('currency-select') as HTMLSelectElement;
  const monthlyBtn = document.getElementById('monthly-btn') as HTMLButtonElement;
  const yearlyBtn = document.getElementById('yearly-btn') as HTMLButtonElement;
  const priceElements = document.querySelectorAll('.price');
  const symbolElements = document.querySelectorAll('.currency-symbol');
  const billingPeriods = document.querySelectorAll('.billing-period');

  function updatePrices() {
    priceElements.forEach((el) => {
      const prices = JSON.parse(el.getAttribute(`data-${currentBilling}`) || '{}');
      el.textContent = prices[currentCurrency]?.toLocaleString() || '0';
    });
    symbolElements.forEach((el) => {
      el.textContent = symbols[currentCurrency] || currentCurrency;
    });
    billingPeriods.forEach((el) => {
      el.textContent = currentBilling === 'monthly' ? '/month' : '/year';
    });
  }

  function updateBillingButtons() {
    if (currentBilling === 'monthly') {
      monthlyBtn?.classList.add('bg-primary', 'text-white');
      monthlyBtn?.classList.remove('text-gray-600');
      yearlyBtn?.classList.remove('bg-primary', 'text-white');
      yearlyBtn?.classList.add('text-gray-600');
    } else {
      yearlyBtn?.classList.add('bg-primary', 'text-white');
      yearlyBtn?.classList.remove('text-gray-600');
      monthlyBtn?.classList.remove('bg-primary', 'text-white');
      monthlyBtn?.classList.add('text-gray-600');
    }
  }

  select?.addEventListener('change', (e) => {
    currentCurrency = (e.target as HTMLSelectElement).value;
    updatePrices();
  });

  monthlyBtn?.addEventListener('click', () => {
    currentBilling = 'monthly';
    updateBillingButtons();
    updatePrices();
  });

  yearlyBtn?.addEventListener('click', () => {
    currentBilling = 'yearly';
    updateBillingButtons();
    updatePrices();
  });

  // Auto-detect country (optional enhancement)
  // fetch('https://ipapi.co/json/').then(r => r.json()).then(data => {
  //   const countryToCurrency: Record<string, string> = { AE: 'AED', SA: 'SAR', KW: 'KWD', QA: 'QAR', BH: 'BHD', OM: 'OMR' };
  //   currentCurrency = countryToCurrency[data.country_code] || 'USD';
  //   select.value = currentCurrency;
  //   updatePrices();
  // });
</script>
